#!/bin/sh

##################
# created 2017-12-27
# by Thomas Frohwein (thfr)
#################
# Script to get FNA-based games
# ready to run on OpenBSD
#
# FNA is a reimplementation of the Microsoft XNA Game Studio 4.0 Refresh libraries.
# Thanks to the great work by Ethan Lee (flibitijibibo) games using FNA are
# highly portable and can even run on OpenBSD.
# Please refer to https://fna-xna.github.io/ for more information about FNA
##################
# Requirements:
#
# - SDL2 library that identifies as 'Linux' rather than 'OpenBSD'
#   (needs to be compiled this way; patch to recognize OpenBSD in
#   progress upstream)
# - mono
# - some additional libraries, like mojoshader, theorafile, etc
##################
# Usage:
#
# sh /path/to/fnaify <launch script>
#
# Enable verbose output by setting environment variable FNAIFY_DEBUG
#
##########
# TODO:
# - test that can be invoked without bugs from outside the game folder
# - fix regex for libraries: 'libSDL2.so' -> '.' is regex character (for any)
# - test that fnaify can be invoked repeatedly without getting buggy (same
#   result expected)
# - fix duplicate appearance of library names (happens with RCRU)
#   if it works. Remove from ignoredarray after testing (TowerFall: Ascension ADD-ON)
# - set to take game directory as the argument rather than the script
# - go through FIXME's
# - make launcher script have generic, neutral name, like 'runfna_<name of game>'
# - currently, ignoredarray needs version of libfmod{,studio}.so.10. fix it so this isn't needed
# - remove libtiny_jpeg.so from ignoredarray (only needed for MidBoss)
# - make warning about replacing FNA.dll more visible - e.g. set variable and check it at the end
# - consider adding instructions on which packages to install for the missing libraries
#########

#########
# VARIABLE AND FUNCTION DEFINITIONS
#########

SAVEIFS=$IFS

#monofilearray: array of mono files that need to be removed from the game folder
#ignoredarray: array of lib names to ignore for the configuration checking
#needlibarray[*] is the array that will hold the names of needed libraries
#foundlibarray[*] is the array of the libraries that were found to match
#                 needlibarray
#missinglibs[*] accumulates missing library names to inform user

# printdash: print $1 number of dashes in one line, followed by newline
printdash()
{
	c=1
	while [[ $c -le $1 ]]
	do
		print -n - -
		let c=c+1
	done
	print ""
}

# inarray: check if $1 is in array $2 (with simple grep)
inarray()
{
	firstarg="$1"
	shift 1
	print "$*" | fgrep -q "$firstarg"
	return
}

# validlib: returns 0 unless $1 is in ignoredarray, then returns 1
# FIXME: this won't be able to deal with whitespace at the moment
validlib()
{
	ig=1
	while [[ $ig -le ${#ignoredarray[*]} ]]
	do
		if [[ $1 = ${ignoredarray[ig]} ]]
		then
			return 1
		fi
		let ig=ig+1
	done
	return 0
}

# trunklibnam: truncate the name of the library (and remove '-2.0') to match OpenBSD
trunklibnam()
{
	libnam="$1"
	libnam="$(print "$libnam" | sed -n -E "s/(.*\.so)\.?.*/\1/p")"
	libnam="$(print "$libnam" | sed -E "s/(libSDL2[^-]*)-2\.0(\.so.*)/\1\2/")"
	print "$libnam"
}

#######################################################################

#######
# MAIN SCRIPT
#######
print ""
print "Performing initial checks..."
if [ -n "$FNAIFY_DEBUG" ]
then
	printdash 28
fi
if [[ ! -e "$1" ]]
then
	print "file not found: $1"
	print ""
	exit 1
fi
if [ -n "$FNAIFY_DEBUG" ]
then
	print "found file $1"
fi

# FIXME: make independent of the useless bash script (just take directory as parameter, if any)
# FIXME: need to make sure that no important file is changed
if [ -n "$FNAIFY_DEBUG" ]
then
	print "found file type: `file -b \"$1\"`"
	print "Done with initial checks."
	print ""
fi

# path and file variable definitions
fullfnaifypath="$0"
fnaifyfile="`basename \"$fullfnaifypath\"`"
fnaifydir="`dirname \"$fullfnaifypath\"`"
fullscriptpath="`pwd`/$1"
scriptfile="`basename \"$fullscriptpath\"`"
gamedir="`dirname \"$fullscriptpath\"`"
IFS="
"
for xfile in $(ls "$gamedir" | grep "\.exe$")
do
	exefile[${#exefile[*]} + 1]=$xfile
done
IFS=$SAVEIFS

# read names of monofiles to move out of the directory, as well as library
# files to ignore from files
if [ -n "$FNAIFY_DEBUG" ]
then
	print "reading names of monolist and ignorelist"
fi
while IFS= read -r line
do
	monofilearray[${#monofilearray[*]} + 1]=$line
done <"$fnaifydir/monolist"
while IFS= read -r line
do
	ignoredarray[${#ignoredarray[*]} + 1]=$line
done <"$fnaifydir/ignorelist"
IFS=$SAVEIFS

# configfilesarray: array of files in gamedir ending in '.config'
if [ -n "$FNAIFY_DEBUG" ]
then
	print "Identifying config files..."
fi
IFS="
"
for cfile in $(ls "$gamedir" | grep "\.config$")
do
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "\tfound config file: $cfile"
	fi
	configfilesarray[${#configfilesarray[*]} + 1]="$cfile"
done
IFS=$SAVEIFS
if [ -n "$FNAIFY_DEBUG" ]
then
	print "Done identifying config files."
	print ""
fi

####
# identify required libraries
####
# - this is likely imperfect and may identify too many or too few libraries
# - at the moment will check 3 sources: lib64, lib, and .config files
# - filenames not whitespace-safe, but should not be used in such files anyway
####

if [ -n "$FNAIFY_DEBUG" ]
then
	print "Identifying libraries required by the game..."
	printdash 45
fi

# get library names from lib64 folder
if [ -n "$FNAIFY_DEBUG" ]
then
	print ""
fi
if [[ ! -e "$gamedir/lib64" ]]
then
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Couldn't find library directory $gamedir/lib64"
	fi
else
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Entering library directory $gamedir/lib64"
	fi
	for file in $(ls "$gamedir/lib64")
	do
		# sort out libs (e.g. steam) that need to be ignored
		validlib $file
		if [[ $? -eq 1 ]]
		then
			continue
		fi
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print -n "\tfound library file: $file"
		fi
		file=$(trunklibnam "$file")
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print " -> $file"
		fi
		inarray $file ${needlibarray[*]}
		if [[ $? -eq 0 ]]
		then
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print " - already in array"
			fi
		elif [[ $? -eq 1 ]]
		then
			needlibarray[${#needlibarray[*]} + 1]=$file
		else
			print "\n\t - ERROR: inarray returned with unexpected error"
			print ""
			exit 1
		fi
	done
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Done with library directory $gamedir/lib64"
	fi
fi

# get library names from lib folder
if [ -n "$FNAIFY_DEBUG" ]
then
	print ""
fi
if [[ ! -e "$gamedir/lib" ]]
then
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Couldn't find library directory $gamedir/lib"
	fi
else
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Entering library directory $gamedir/lib"
	fi
	for file in $(ls "$gamedir/lib")
	do
		# sort out libs (e.g. steam) that need to be ignored
		validlib $file
		if [[ $? -eq 1 ]]
		then
			continue
		fi
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print -n "\tfound library file: $file"
		fi
		file=$(trunklibnam "$file")
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print -n " -> $file"
		fi
		inarray $file ${needlibarray[*]}
		if [[ $? -eq 0 ]]
		then
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print " - already in array"
			fi
		elif [[ $? -eq 1 ]]
		then
			needlibarray[${#needlibarray[*]} + 1]=$file
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print ""
			fi
		else
			print "\n\t - ERROR: inarray returned with unexpected error"
			print ""
			exit 1
		fi
	done
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Done with library directory $gamedir/lib"
	fi
fi

# get library names from .config files
if [ -n "$FNAIFY_DEBUG" ]
then
	print "Obtaining library names from the following config files"
fi

# check that configfilesarray isn't empty
if [[ ${#configfilesarray[*]} < 1 ]]
then
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "No config files found."
	fi
else
	cfile=""	# empty the variable because it has been used before
	IFS="
	"
	for cfile in ${configfilesarray[*]}
	do
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print "\t$cfile"
		fi
		linuxlines=$(grep "os\=\"linux" $gamedir/$cfile)
		# FIXME: this sed call would probably get messed up if there is
		#	whitespace
		for libstring in $(print "$linuxlines" | sed -n -E "s/.*target=\"([^\"]+).*/\1/p")
		do
			# Fix where library name includes directory information
			# remove "./" at the beginning of librarynames
			libstring=$(print "$libstring" | sed -E 's/^.\///')
			# remove directories at the start of lib name
			libstring=$(print "$libstring" | sed -E 's/^.*\///')
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print -n "\t\tFound library string: $libstring"
			fi
			# sort out libs (e.g. steam) that need to be ignored
			validlib $libstring
			if [[ $? -eq 1 ]]
			then
				if [ -n "$FNAIFY_DEBUG" ]
				then
					print " - ignored"
				fi
				continue
			fi
			# truncate/fix SDL2 names{,s}
			libstring=$(trunklibnam "$libstring")
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print -n " -> $libstring"
			fi
			#needlibarray[${#needlibarray[*]} + 1]=$libstring
			# check if libstring is already in needlibarray.
			# add to needlibarray only if not.
			inarray $libstring ${needlibarray[*]}
			if [[ $? -eq 0 ]]
			then
				if [ -n "$FNAIFY_DEBUG" ]
				then
					print " - already in array"
				fi
			elif [[ $? -eq 1 ]]
			then
				needlibarray[${#needlibarray[*]} + 1]=$libstring
				if [ -n "$FNAIFY_DEBUG" ]
				then
					print " - added to array"
				fi
			else
				print "\n\t - ERROR: inarray returned with unexpected error"
				print ""
				exit 1
			fi
		done
	done
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Done with identifying libraries in config files"
	fi
fi
if [ -n "$FNAIFY_DEBUG" ]
then
	print "Done with identification of needed libraries."
fi
IFS=$SAVEIFS

# Fix libpngXX.so filename
if [ -n "$FNAIFY_DEBUG" ]
then
	print -n "Fixing libpng filenames if present..."
fi
i=1
while [[ i -le ${#needlibarray[*]} ]]
do
	needlibarray[i]=$(print "${needlibarray[i]}" | sed -E "s/(libpng)..(\.so.*)/\1\2/")
	let i=i+1
done
if [ -n "$FNAIFY_DEBUG" ]
then
	print " done."
	print ""
fi

# Check if the libraries are available on the system (/usr/local/lib).
# If not, break and inform user which libraries need to be installed.
print "Checking installed libraries..."

i=1
while [[ i -le ${#needlibarray[*]} ]]
do
	if [[ $(ls /usr/local/lib | grep "^${needlibarray[i]}") != "" ]]
	then
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print "\tfound system lib for: ${needlibarray[i]}"
		fi
	else
		if [ -n $(print ${needlibarray[i]} | grep -q 'libfreetype\.so.*')
		then
			# DEBUG
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print "\tfound libfreetype (see /usr/X11R6/lib)"
			fi
		else
			if [ -n "$FNAIFY_DEBUG" ]
			then
				print "\tNot found: ${needlibarray[i]}"
			fi
			missinglibs[${#missinglibs[*]} + 1]=${needlibarray[i]}
		fi
	fi
	let i=i+1
done
if [ -n "$FNAIFY_DEBUG" ]
then
	print ""
fi

# Check if mono is available
if [ -n "$FNAIFY_DEBUG" ]
then
	print -n "Checking that mono can be called..."
fi
missingmono=0
whence mono > /dev/null
if [[ $? -ne 0 ]]
then
	print " Couldn't find mono in PATH"
	missingmono=1
else
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print " Found mono."
	fi
fi
print ""

# check version of framework library (FNA.dll or MonoGame.Framework.dll)
if [ $missingmono -lt 1 ]
then

	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Checking version of framework library..."
	fi
	# the following code assumes that only one of FNA.dll and MonoGame.Framework.dll is present
	if [ -e "$gamedir/FNA.dll" ]
	then
		fnaversion=`monodis --assembly "$gamedir/FNA.dll" | grep "Version" | tr -d [:alpha:] | tr -d " " | tr -d \:`
		fnamajor=`print "$fnaversion" | sed -n -E "s/\..*//p"`
		fnaminor=`print "$fnaversion" | sed -n -E "s/[0-9]+\.([0-9]+)\.[0-9]+\.[0-9]+/\1/p"`
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print "\tFound FNA.dll version $fnaversion"
			print "fnamajor: $fnamajor"
			print "fnaminor: $fnaminor"
		fi
		if [ $fnamajor -lt 16 ] || ( [ $fnamajor -eq 16 ] && [ $fnaminor -lt 5 ] )
		then
			print "WARNING: version of FNA.dll potentially incompatble!"
			print "If unable to launch with this version, consider replacing with newer version."
			print "Source available at https://github.com/FNA-XNA/FNA/releases"
		fi
	elif [ -e "$gamedir/MonoGame.Framework.dll" ]
	then
		mgversion=`monodis --assembly "$gamedir/MonoGame.Framework.dll" | grep "Version" | tr -d [:alpha:] | tr -d " " | tr -d \:`
		#mgmajor=`print "$mgversion" | sed -n -E "s/\..*//p"` # not needed because at this point not checking mg version
		if [ -n "$FNAIFY_DEBUG" ]
		then
			print "\tFound MonoGame.Framework.dll version $mgversion"
		fi
	else
		print "WARNING: Could not find framework library (FNA.dll or MonoGame.Framework.dll) in $gamedir"
	fi
else
	if [ -n "$FNAIFY_DEBUG" ]
	then
		print "Can't check version of framework library because couldn't find mono"
	fi
fi
print ""

print -n "Result of configuration testing: "
if [[ ( ${#missinglibs[*]} -gt 0 ) || ( $missingmono -gt 0 ) ]]
then
	print "FAILED"
	printdash 39
	
	print "The following requirements were not met:"
	if [[ $missingmono = 1 ]]
	then
		print -n - -
		print " Could not find 'mono' in PATH"
	fi
	if [[ ${#missinglibs[*]} > 0 ]]
	then
		i=1
		while [[ i -le ${#missinglibs[*]} ]]
		do
			print -n - -
			print " Could not find library: ${missinglibs[i]}"
			let i=i+1
		done
	fi
	print ""
	exit 1
fi
print "SUCCESS"
if [ -n "$FNAIFY_DEBUG" ]
then
	printdash 40
fi

####
# replace all occurences of 'linux' in .config files (dllmap) with 'openbsd'
#    (this won't be needed after fna 18.01+ rolled out)

print ""
print "Adjusting config files for OpenBSD..."

# create backup .linux files of the original .config files
# (unless this has already been done; then don't overwrite)
if [ -n "$FNAIFY_DEBUG" ]
then
	print -n "\t(creating copy of original config files with suffix '.linux')... "
fi
IFS="
"
for file in $(ls "$gamedir" | grep "\.config$")
do
	if [[ ! -e "$gamedir/$file.linux" ]]
	then
		cp -p "$gamedir/$file" "$gamedir/$file.linux"
	fi
done
IFS=$SAVEIFS
if [ -n "$FNAIFY_DEBUG" ]
then
	print "done."
fi

# now replace all terms in *.config
IFS="
"
for file in $(ls "$gamedir" | grep "\.config$")
do
	# someone may be able to provide a more compact solution for this section
	# remove "./" at the beginning of any target="..."
	sed -i -E 's/(.*target=")\.\/(.*)$/\1\2/g' "$gamedir/$file"
	# remove directory lib{,64} at the start of any target="..."
	sed -i -E 's/(.*target=")lib(64)?\/(.*)$/\1\3/g' "$gamedir/$file"
	sed -i 's/os="linux/os="openbsd/g' "$gamedir/$file"
	# remove suffix numbers
	sed -i -E 's/(target="lib.*.so)[\.0-9]*(.*)$/\1\2/g' "$gamedir/$file"
	# fix SDL2 naming by removing the '-2.0'
	sed -i -E 's/(target="libSDL2.*)-2\.0(\.so.*)$/\1\2/g' "$gamedir/$file"
	# FIXME: find out where 'dll=' is used with .so and how often
	# 	(there was an example with libfreetype in this place somewhere)
	sed -i -E 's/(dll="lib[a-zA-Z]*\.so)[\.0-9]*(.*)$/\1\2/g' "$gamedir/$file"
done
IFS=$SAVEIFS
if [ -n "$FNAIFY_DEBUG" ]
then
	print "Config files adjusted."
fi

# Move interfering mono files out of the way
if [ -n "$FNAIFY_DEBUG" ]
then
	print -n "Moving some bundled dll files into linux-files subfolder... "
fi
i=1
while [[ i -le ${#monofilearray[*]} ]]
do
	if [[ -e "$gamedir/${monofilearray[i]}" ]]
	then
		if [[ ! -e "$gamedir/linux-files" ]]
		then
			mkdir "$gamedir/linux-files"
		fi
		mv "$gamedir/${monofilearray[i]}" "$gamedir/linux-files"
	fi
	let i=i+1
done
if [ -n "$FNAIFY_DEBUG" ]
then
	print " done."
fi

###
# copy wrapper script template into the game folder, set correct .exe in script, and set to executable

if [[ ${#exefile[*]} -gt 1 ]]
then
	i=0
	while [[ ++i -le ${#exefile[*]} ]]
	#for i in {1..${#exefile[*]}}
	do
		print "$i: ${exefile[i]}"
	done
	print -n "Enter number of .exe file to choose for wrapper script: "
	# FIXME: this breaks with error when whitespace in input
	while [[ $input -lt 1 || $input -gt ${#exefile[*]} ]]
	do
		read input
	done
	selectexe="${exefile[$input]}"
elif
then
	selectexe="${exefile[1]}"
else
	print "ERROR: no .exe file found"
	print ""
	exit 1
fi

print "Replacing launcher script with OpenBSD variant..."
# if not exists, make backup of original script for linux
if [ -n "$FNAIFY_DEBUG" ]
then
	print -n "\t(creating copy of original launcher script with suffix '.linux')... "
fi
if [ ! -e "$fullscriptpath.linux" ]
then
	cp -p "$fullscriptpath" "$fullscriptpath.linux"
fi
if [ -n "$FNAIFY_DEBUG" ]
then
	print "done."
fi
cp "$fnaifydir/wrapper.template" "$fullscriptpath"
if [[ $scriptfile = "Hacknet" ]]
then
	sed -i "s/<WINDOWS_EXECUTABLE>/\"$selectexe\" -disableweb/g" "$fullscriptpath"
elif [ $scriptfile = "Wizorb" ]
then
	sed -i "s/<WINDOWS_EXECUTABLE>/\"$selectexe\"/g" "$fullscriptpath"
	sed -i "s/LD_LIBRARY_PATH=\/usr\/local\/lib/LD_LIBRARY_PATH=\/usr\/local\/lib MONO_IOMAP=all/g" "$fullscriptpath"
else
	sed -i "s/<WINDOWS_EXECUTABLE>/\"$selectexe\"/g" "$fullscriptpath"
fi
chmod +x "$fullscriptpath"
if [ -n "$FNAIFY_DEBUG" ]
then
	print "Launcher script replaced."
	print ""
fi
if [ -n "$FNAIFY_DEBUG" ]
then
	print "SETUP COMPLETE"
	printdash 14
fi
print ""
print "You should now be able to start the game by running:"
print ""
print "\$ ./$scriptfile"
print ""
